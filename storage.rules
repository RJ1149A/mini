rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Allow authenticated users to read all files
    match /{allPaths=**} {
      allow read: if request.auth != null;
    }

    // Feed folder - users can upload their own photos/videos
    match /feed/{userId}/{fileName} {
      allow write: if 
        request.auth != null && 
        request.auth.uid == userId &&
        request.auth.token.email.matches('.*@miet\\.ac\\.in$') &&
        request.resource.size < 52428800; // 50MB limit
    }

    // Media folder - users can upload their own photos/videos
    match /media/{userId}/{fileName} {
      allow write: if 
        request.auth != null && 
        request.auth.uid == userId &&
        request.auth.token.email.matches('.*@miet\\.ac\\.in$') &&
        request.resource.size < 52428800; // 50MB limit
    }

    // Academia folder - branch and semester structure, users upload inside their userId folder
    match /academia/{branch}/sem-{sem}/{userId}/{fileName} {
      allow write: if
        request.auth != null &&
        request.auth.uid == userId &&
        request.auth.token.email.matches('.*@miet\\.ac\\.in$') &&
        request.resource.size < 52428800; // 50MB limit
    }

    // Public uploads folder
    match /uploads/{fileName} {
      allow write: if 
        request.auth != null &&
        request.auth.token.email.matches('.*@miet\\.ac\\.in$') &&
        request.resource.size < 52428800; // 50MB limit
    }
  }
}
